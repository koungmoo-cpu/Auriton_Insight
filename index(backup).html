<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auriton AI ìš´ëª… ì§„ë‹¨</title>
    <link rel="stylesheet" href="style.css">
    <script>
    window.CLAUDE_API_KEY = 'your-claude-api-key-here';
</script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Auriton AI ìš´ëª… ì§„ë‹¨</h1>
            <p class="subtitle">ë‹¹ì‹ ì˜ ìš´ëª…ì„ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤</p>
        </div>
        
        <form id="sajuForm" class="form-container">
            <div class="form-group">
                <label for="userName">ì„±í•¨ <span class="required">*</span></label>
                <input 
                    type="text" 
                    id="userName" 
                    name="userName"
                    placeholder="ì˜ˆ: í™ê¸¸ë™ ë˜ëŠ” John Smith"
                    maxlength="100"
                    required
                >
                <span class="error-message" id="userNameError"></span>
            </div>

            <div class="form-group">
                <label for="location">íƒœì–´ë‚œ ì§€ì—­ <span class="required">*</span></label>
                <input 
                    type="text" 
                    id="location" 
                    name="location"
                    placeholder="ì˜ˆ: ì„œìš¸, ë¶€ì‚°, ê²½ê¸°ë„ ìˆ˜ì›ì‹œ"
                    required
                >
                <span class="error-message" id="locationError"></span>
            </div>

            <div class="form-group gender-group">
                <label>ì„±ë³„ <span class="required">*</span></label>
                <div class="gender-toggle">
                    <label class="gender-check">
                        <input type="checkbox" id="genderMale" onclick="selectGenderCheckbox('male')">
                        <span>ë‚¨ì„±</span>
                    </label>
                    <label class="gender-check">
                        <input type="checkbox" id="genderFemale" onclick="selectGenderCheckbox('female')">
                        <span>ì—¬ì„±</span>
                    </label>
                </div>
                <input type="hidden" id="gender" name="gender">
                <span class="error-message" id="genderError"></span>
            </div>

            <div class="form-group">
                <label for="birthDateInput">ìƒë…„ì›”ì¼ <span class="required">*</span></label>
                <input 
                    type="text" 
                    id="birthDateInput" 
                    name="birthDateInput"
                    placeholder="ì˜ˆ: 19900101"
                    inputmode="numeric"
                    maxlength="8"
                    required
                >
                <span class="error-message" id="birthDateError"></span>
            </div>
            
            <div class="form-group">
                <label for="birthTime">íƒœì–´ë‚œ ì‹œê°„ <span class="required">*</span></label>
                <div class="time-select-container">
                    <select id="birthTime" name="birthTime" required>
                        <option value="" disabled selected>ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="unknown">ì‹œê°„ ëª¨ë¦„</option>
                        <option value="00:00">ì¡°ì/æœå­ (00:00~01:29)</option>
                        <option value="01:30">ì¶•/ä¸‘ (01:30~03:29)</option>
                        <option value="03:30">ì¸/å¯… (03:30~05:29)</option>
                        <option value="05:30">ë¬˜/å¯ (05:30~07:29)</option>
                        <option value="07:30">ì§„/è¾° (07:30~09:29)</option>
                        <option value="09:30">ì‚¬/å·³ (09:30~11:29)</option>
                        <option value="11:30">ì˜¤/åˆ (11:30~13:29)</option>
                        <option value="13:30">ë¯¸/æœª (13:30~15:29)</option>
                        <option value="15:30">ì‹ /ç”³ (15:30~17:29)</option>
                        <option value="17:30">ìœ /é…‰ (17:30~19:29)</option>
                        <option value="19:30">ìˆ /æˆŒ (19:30~21:29)</option>
                        <option value="21:30">í•´/äº¥ (21:30~23:29)</option>
                        <option value="23:30">ì•¼ì/å¤œå­ (23:30~23:59)</option>
                    </select>
                </div>
                <span class="error-message" id="birthTimeError"></span>
            </div>
            
            <div class="form-group">
                <label for="calendarType">ë‹¬ë ¥ ì„ íƒ <span class="required">*</span></label>
                <select id="calendarType" name="calendarType" required>
                    <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                    <option value="solar">ì–‘ë ¥</option>
                    <option value="lunar">ìŒë ¥(í‰ë‹¬)</option>
                    <option value="lunar_leap">ìŒë ¥(ìœ¤ë‹¬)</option>
                </select>
                <span class="error-message" id="calendarTypeError"></span>
            </div>
            
            <button 
                type="submit" 
                id="analyzeBtn" 
                class="analyze-button" 
                disabled
            >
                ë¶„ì„ ì‹œì‘
            </button>
        </form>

        <div id="resultArea" class="result-area" style="display: none;">
            <h3>ë¶„ì„ ê²°ê³¼ (Raw Data)</h3>
            <p id="sajuData"></p>
            <p id="astrologyData"></p>
            <hr>
            <h3>AI ìƒë‹´ì‚¬ ì¸í„°í”„ë¦¬íŒ…</h3>
            <div id="chatContainer" class="chat-container">
                <div id="chatMessages" class="chat-messages"></div>
                <div class="chat-input-container">
                    <input 
                        type="text" 
                        id="chatInput" 
                        class="chat-input" 
                        placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”..."
                        maxlength="500"
                    >
                    <button 
                        type="button" 
                        id="sendButton" 
                        class="send-button"
                        onclick="sendUserMessage()"
                    >
                        ì „ì†¡
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
// 1. ì´ˆê¸° ë¶„ì„ì´ ì™„ë£Œëœ í›„ ì´ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ì—¬ ì§ˆë¬¸ì°½ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
function showAdditionalQuestion() {
    const section = document.getElementById('additional-question-section');
    if (section) {
        section.style.display = 'block'; // ìˆ¨ê²¨ì§„ ì„¹ì…˜ì„ ë‚˜íƒ€ëƒ„
        section.scrollIntoView({ behavior: 'smooth' }); // ìì—°ìŠ¤ëŸ½ê²Œ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
    }
}

// 2. ì‹¤ì‹œê°„ ê¸€ì ìˆ˜ ì¹´ìš´í„° ë¡œì§
const questionInput = document.getElementById('userQuestion');
const charCountDisplay = document.getElementById('charCount');

if (questionInput && charCountDisplay) {
    questionInput.addEventListener('input', function() {
        const length = this.value.length;
        charCountDisplay.innerText = length;
        
        // 180ì ì´ìƒ ì‹œ ì‹œê°ì  ê²½ê³ 
        if (length >= 180) {
            charCountDisplay.className = 'text-xs font-bold text-red-500';
        } else {
            charCountDisplay.className = 'text-xs font-semibold text-gray-400';
        }
    });
}

// 3. ê¸°ì¡´ ë¶„ì„ ì„±ê³µ ì‹œì ì— showAdditionalQuestion()ì„ í˜¸ì¶œí•˜ë„ë¡ ì—°ê²°í•˜ì„¸ìš”.
// ì˜ˆ: result.successì¼ ë•Œ UIë¥¼ ê·¸ë¦° í›„ showAdditionalQuestion() ì‹¤í–‰
</script>

<div id="additional-question-section" class="mt-8 border-t pt-6" style="display: none;">
    <label class="block text-gray-700 font-bold mb-3 ml-1">
        AI ìƒë‹´ì‚¬ì—ê²Œ ì¶”ê°€ ì§ˆë¬¸í•˜ê¸° (200ì ì œí•œ)
    </label>
    
    <div class="relative">
        <textarea 
            id="userQuestion" 
            maxlength="200"
            class="w-full p-4 pb-12 border-2 border-gray-100 rounded-2xl focus:border-blue-500 outline-none resize-none transition-all shadow-sm"
            placeholder="ìƒë‹´ ë‚´ìš© ì¤‘ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”."
            rows="3"
        ></textarea>
        
        <div class="absolute bottom-4 right-5 flex items-center bg-white/90 px-2 py-0.5 rounded-lg pointer-events-none">
            <span id="charCount" class="text-xs font-semibold text-gray-400">0</span>
            <span class="text-xs text-gray-300">/200</span>
        </div>
    </div>

    <button id="sendQuestionBtn" class="w-full mt-4 bg-blue-900 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-transform">
        ì§ˆë¬¸ ì „ì†¡í•˜ê¸°
    </button>
</div>

<script src="https://cdn.jsdelivr.net/gh/6tail/lunar-javascript@latest/lunar.min.js"></script>
<script src="script.js"></script>

<script>
// âœ… ì§ˆë¬¸ì°½ ë…¸ì¶œ í•¨ìˆ˜
function showAdditionalQuestion() {
    const section = document.getElementById('additional-question-section');
    if (section) {
        section.style.display = 'block';
        section.scrollIntoView({ behavior: 'smooth' });
        console.log("ğŸš€ ì¶”ê°€ ì§ˆë¬¸ì°½ í™œì„±í™” ì™„ë£Œ");
    }
}

// âœ… 200ì ì‹¤ì‹œê°„ ì¹´ìš´í„° ë¡œì§
const questionInput = document.getElementById('userQuestion');
const charCountDisplay = document.getElementById('charCount');

if (questionInput && charCountDisplay) {
    questionInput.addEventListener('input', function() {
        const length = this.value.length;
        charCountDisplay.innerText = length;

        if (length >= 180) {
            charCountDisplay.classList.add('text-red-500', 'font-bold');
        } else {
            charCountDisplay.classList.remove('text-red-500', 'font-bold');
        }
    });
}

// âœ… ì§ˆë¬¸ ì „ì†¡ ë²„íŠ¼ ì´ë²¤íŠ¸
document.getElementById('sendQuestionBtn').addEventListener('click', async () => {
    const message = questionInput.value.trim();
    if (!message) return alert("ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    
    const btn = document.getElementById('sendQuestionBtn');
    btn.disabled = true; // ì¤‘ë³µ í´ë¦­ ë°©ì§€
    
    await sendChatMessage(message);
    
    btn.disabled = false;
});

// âœ… ì¶”ê°€ ì§ˆë¬¸ ì „ì†¡ ë° ë‹µë³€ ì²˜ë¦¬ í•¨ìˆ˜
async function sendChatMessage(userMessage) {
    const section = document.getElementById('additional-question-section');
    const questionContainer = section.querySelector('.relative'); // ì…ë ¥ì°½ ì˜ì—­ ë³´ì¡´
    
    // ë¡œë”© í‘œì‹œ ì¶”ê°€ (ê¸°ì¡´ ì…ë ¥ì°½ ì•„ë˜ì— ìƒì„±)
    const loadingMsg = document.createElement('p');
    loadingMsg.className = 'text-blue-600 animate-pulse font-bold p-4 text-center';
    loadingMsg.innerText = 'âœ¨ Simonë‹˜ì˜ ì‚¬ì£¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹µë³€ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...';
    section.appendChild(loadingMsg);

    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userMessage: userMessage,
                rawData: window.globalRawData // ë¶„ì„ ì‹œ ì €ì¥í•´ë‘” ì „ì—­ ë³€ìˆ˜
            })
        });

        const result = await response.json();
        loadingMsg.remove(); // ë¡œë”© ì œê±°

        if (result.success) {
            // ë‹µë³€ ë°•ìŠ¤ ìƒì„±
            const answerBox = document.createElement('div');
            answerBox.className = "mt-4 p-5 bg-blue-50 rounded-2xl border-l-4 border-blue-500 shadow-sm";
            answerBox.innerHTML = `
                <p class="font-bold text-gray-800 mb-2 text-sm">ë‚˜ì˜ ì§ˆë¬¸: ${userMessage}</p>
                <p class="text-gray-700 leading-relaxed"><span class="font-bold text-blue-600">ë‹µë³€:</span> ${result.answer}</p>
            `;
            section.appendChild(answerBox);
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            questionInput.value = '';
            charCountDisplay.innerText = '0';
        }
    } catch (error) {
        console.error("í†µì‹  ì˜¤ë¥˜:", error);
        loadingMsg.remove();
        alert("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
}
</script>
</body>
</html>
